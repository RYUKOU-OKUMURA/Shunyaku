# ローカルホバー翻訳アプリ 実装プラン（Codex MCPレビュー版）

最終更新: 2025-09-23
レビュー者: Codex MCP + Claude Code
ベース: 要件定義書（tauri_react・非エンジニア向け）

---

## エグゼクティブサマリ

**目的**: macOS上で「スクショ→OCR→翻訳→即表示→保存」を5秒以内で実現するローカルアプリの開発
**技術スタック**: Tauri + React/TypeScript + TailwindCSS + Tesseract.js + DeepL API
**開発期間**: 22週間（6フェーズ）
**成功指標**: 翻訳5秒以内、失敗率<5%、設定復元100%、保存成功率100%

---

## プロジェクト構成

```
/Shunyaku
  /docs                 # 実装プラン・仕様書・手順書
  /src                  # React/TypeScript フロントエンド
    /components         # UIコンポーネント
    /store             # 状態管理・設定（Zustand）
    /workers           # Tesseract.js ワーカー
    /lib               # API・ユーティリティ
    /types             # 共有型定義
  /src-tauri           # Rust バックエンド（最小限）
    /src               # Tauriコマンド
  /tests               # E2Eテスト（Playwright）
  /.storybook          # UIコンポーネントドキュメント
```

---

## 改良された6フェーズ計画

###  Phase 1(Week 1-3): 基盤構築 + 早期検証
**目標**: 開発環境確立と技術リスク早期検証

1. **プロジェクトセットアップ**
   - [x] Tauriプロジェクト初期化（`create-tauri-app`）
   - [x] React + TypeScript + TailwindCSS 環境構築
   - [x] ESLint/Prettier/Vitest 導入

2. **技術PoC（新規追加）**
   - [x] Tesseract.js冷起動時間・メモリ使用量計測
   - [x] DeepL API レスポンス時間・レート制限確認
   - [x] Tauriマルチウィンドウ（フローティングパネル）動作検証

3. **基盤実装**
   - [x] 共有型定義作成（`tauri-specta`検討）
   - [x] モックサービス（OCR/翻訳）
   - [x] Storybook導入（非エンジニア向けUI確認）
     - 2025-09-23: `.storybook`構成と主要コンポーネントの`*.stories.tsx`に加え、必要なStorybook依存関係を`package.json`へ追加済み。`npm run storybook`での動作確認完了（http://localhost:6006で正常起動）。

4. **配布要件調査（前倒し）**
   - [ ] Apple Developer ID取得手順確認
   - [ ] コードサイニング・公証プロセス調査

**Exit条件**: OCR/翻訳のパフォーマンスベースライン確立、配布手順明確化

### Phase 2 (Week 4-7): 画像入力・OCR最適化
**目標**: OCR処理の実装と性能目標達成

1. **画像入力実装**
   - [x] ドラッグ&ドロップゾーン（PNG/JPG/PDF対応）
     - 2025-09-25: `DropZone`コンポーネントでPNG/JPG/PDF対応、ファイルサイズ制限、画像サイズ取得機能を実装済み。
   - [x] クリップボード監視（`tauri-plugin-clipboard`）
     - 2025-09-25: `ClipboardService`でポーリング監視、画像フォーマット検出、変更検知ハッシュ機能を実装済み。

2. **OCR実装・最適化**
   - [x] Tesseract.js Web Worker統合
     - 2025-09-25: `OCRWorkerManager`で完全なワーカー統合、メッセージプロトコル、エラーハンドリングを実装済み。
   - [x] ワーカーウォームアップ機能
     - 2025-09-25: 複合言語初期化（eng+jpn）、複数サイズテスト画像での事前キャッシュ機能を実装済み。
   - [x] 言語データ（eng/jpn）キャッシュ戦略
     - 2025-09-25: ローカルlangPath設定、単一ワーカー初期化戦略でCDN依存を排除、キャッシュ最適化済み。
   - [x] 画像前処理パイプライン（リサイズ/二値化）
     - 2025-09-25: 自動リサイズ（最大2000px）、Otsu閾値による適応的二値化、メモリリーク修正を実装済み。

3. **性能検証（重要）**
   - [x] 2000×1200px画像での処理時間計測
     - 2025-09-25: `runDetailedPerformanceTest`と`runStandardBenchmark`を実装済み。2000×1200pxテスト画像生成機能とパフォーマンス計測機能を追加。
   - [x] 各段階（画像読み込み→OCR→テキスト出力）の詳細プロファイリング
     - 2025-09-25: 各処理段階（前処理、OCR処理、テキスト抽出）の詳細な時間測定とメモリスナップショット機能を実装済み。
   - [x] メモリ使用量監視
     - 2025-09-25: `getMemoryUsage`によるメモリ監視機能と、処理前後・ピーク値の記録機能を実装済み。

**Exit条件**: 標準画像で3秒以内OCR完了、メモリ制約内動作確認

### Phase 3 (Week 8-11): 翻訳統合・パイプライン構築
**目標**: OCR→翻訳の完全パイプライン実現

1. **翻訳API統合**
   - [x] DeepL API抽象化レイヤー実装
     - 2025-09-25: `TranslationService`でDeepL API抽象化、レスポンス解析、エラーハンドリングを完全実装済み。
   - [x] APIキー安全保存（`tauri-plugin-store` + 暗号化）
     - 2025-09-25: 暗号化APIキー保存機能（基本実装）を追加済み。TODO: tauri-plugin-storeの本格導入が必要。
   - [x] レート制限・エラーハンドリング
     - 2025-09-25: `RateLimiter`クラスでレート制限管理、`DeepLApiError`による詳細エラーハンドリングを実装済み。

2. **パイプライン最適化**
   - [x] OCR結果の正規化・ノイズ除去
     - 2025-09-25: 多段階テキスト正規化（基本正規化、ノイズ除去、誤認識修正、空白整理、特殊文字正規化）と信頼度調整機能を実装済み。
   - [x] 翻訳キューイング・バッチ処理
     - 2025-09-25: 優先度付きキューイング（`queueTranslation`）とバッチ翻訳（`translateBatch`）機能を実装済み。
   - [x] 再試行戦略実装
     - 2025-09-25: 指数バックオフ、ジッター、再試行可能エラー判定を含む包括的な`RetryStrategy`クラスを実装済み。

3. **性能目標達成**
   - [x] エンドツーエンド5秒以内達成
     - 2025-09-25: `PipelineIntegrationService`でエンドツーエンドパイプライン統合、`runFiveSecondBenchmark`による5秒以内検証機能を実装済み。`PipelineBenchmark`コンポーネントでUI表示対応。
   - [x] 失敗ケース定義と計測開始
     - 2025-09-25: ベンチマーク成功率測定、詳細な失敗ケース記録、メモリメトリクス計測機能を実装済み。

**Exit条件**: 5秒以内翻訳達成、基本的な失敗率<5%

### Phase 4 (Week 12-15): UX向上・永続化・自動テスト
**目標**: 実用的なUIと信頼性の確保

1. **UI/UX実装**
   - [x] フローティング結果パネル（ドラッグ移動・リサイズ）
     - 2025-09-25: ドラッグ&ドロップ、リサイズ、クリップボードコピー、保存機能を実装完了。
   - [x] 設定画面（言語・クリップボード監視・保存先）
     - 2025-09-25: タブ式設定画面、OCR/翻訳/UI/ホットキー設定を実装完了。
   - [x] ショートカット（⌘⌥T）
     - 2025-09-25: グローバルショートカット、設定可能なキー組み合わせ機能を実装完了。
   - [x] プログレス表示・エラートースト
     - 2025-09-25: ステップ別進捗表示、4種類通知システム（成功/エラー/警告/情報）を実装完了。

2. **データ永続化**
   - [x] 履歴機能（直近10件、IndexedDB）
     - 2025-09-25: IndexedDBサービス、Zustandストア統合、最大10件自動管理、検索・エクスポート機能を実装完了。
   - [x] 設定の復元機能
     - 2025-09-25: localStorage暗号化保存、バージョン管理、自動マイグレーション、バックアップ機能を実装完了。
   - [x] ウィンドウ位置記憶
     - 2025-09-25: 画面境界チェック、自動調整、中央配置、複数ウィンドウ状態管理を実装完了。

3. **自動テスト導入**
   - [x] Playwright E2Eテスト構築
     - 2025-09-25: Playwright環境構築完了。設定ファイル、テストディレクトリ構造、CI/CD対応スクリプトを実装済み。
   - [x] 翻訳フロー全体の回帰テスト
     - 2025-09-25: OCR→翻訳完全パイプライン、ドラッグ&ドロップ、履歴保存、設定復元、エラーハンドリングのE2Eテストを実装済み。
   - [x] パフォーマンステスト自動化
     - 2025-09-25: 5秒以内翻訳要件、<5%失敗率測定、大画像処理、連続操作性能のテスト自動化を実装済み。

**Phase4-1 完了実績（2025-09-25）**:
- **実装したコンポーネント**: FloatingPanel、SettingsModal、ProgressIndicator、Toast/ToastContainer、useKeyboardShortcuts、KeyboardShortcutsDemo
- **Storybookドキュメント**: 全コンポーネントにストーリーを作成、非エンジニア向け可視化を実現
- **アプリ統合**: メインAppコンポーネントに統合、「UI Components Demo」でアクセス可能
- **Codex MCPレビュー**: TypeScript型安全性、React パフォーマンス、アクセシビリティを確認
- **品質**: Phase4-1要件を満たし、アクセシビリティ改善提案を受領

**Phase4-2 完了実績（2025-09-25）**:
- **実装したサービス**: historyStorage、settingsStorage、windowStateStorage（IndexedDB/localStorage基盤）
- **Zustandストア**: useHistoryStore、useSettingsStore、useWindowStore（状態管理統合）
- **データ永続化**: 履歴10件管理、設定バックアップ/復元、ウィンドウ状態記憶
- **品質保証**: 型安全性確保、エラーハンドリング強化、バリデーション実装
- **機能**: 検索・フィルタ、インポート/エクスポート、自動クリーンアップ機能を完備

**Phase4-3 完了実績（2025-09-25）**:
- **Playwright E2E環境**: 設定ファイル、テストディレクトリ、CI/CD対応スクリプト完備
- **翻訳フローテスト**: OCR→翻訳パイプライン、D&D、履歴、設定復元、エラーハンドリング
- **パフォーマンステスト**: 5秒以内要件、<5%失敗率、大画像処理、連続実行性能の自動化
- **UI機能テスト**: フローティングパネル、設定モーダル、進捗表示、トースト、アクセシビリティ
- **Codex MCPレビュー**: テスト設計、要件対応、保守性、CI/CD適用性を確認済み
- **品質**: データ・テストID統合、リアルタイムテスト、レポート機能、デバッグサポート完備

**Exit条件**: 非エンジニアが操作可能なUI完成、自動テスト網構築

### Phase 5 (Week 16-19): 高度機能・外部連携
**目標**: 付加価値機能と実用性向上

1. **高度OCR機能**
   - [ ] 画像前処理オプション（コントラスト・ノイズ除去）
   - [ ] 複数言語対応検討

2. **翻訳機能強化**
   - [ ] 簡易用語集・辞書機能
   - [ ] 翻訳履歴検索

3. **外部連携**
   - [ ] URLスキーム保存（Obsidian等）
   - [ ] Downloadsフォールバック
   - [ ] 保存失敗0%の実現

4. **ネイティブOCR準備**
   - [ ] Rust側OCRライブラリ調査
   - [ ] FFI境界設計検討

**Exit条件**: 外部連携100%成功、ネイティブOCR移行準備完了

### Phase 6 (Week 20-22): 配布準備・ドキュメント・品質保証
**目標**: リリース可能な品質とサポート体制構築

1. **セキュリティ・プライバシー**
   - [ ] セキュリティレビュー実施
   - [ ] プライバシーポリシー策定
   - [ ] ライセンス管理（OSS依存関係）

2. **配布準備**
   - [ ] Apple Developer ID署名
   - [ ] アプリ公証（notarization）
   - [ ] インストーラー（.dmg）作成

3. **サポート体制**
   - [ ] ユーザーマニュアル・FAQ作成
   - [ ] クラッシュレポート収集仕組み
   - [ ] ログ収集・匿名化ポリシー

4. **品質保証**
   - [ ] 最終統合テスト
   - [ ] 非エンジニアによるベータテスト
   - [ ] 成功指標達成確認

**Exit条件**: リリース候補版完成、配布・サポート体制確立

---

## 技術決定事項（レビュー反映）

### 修正・追加事項
1. **性能検証の前倒し**: Phase 2でOCR性能、Phase 3で翻訳性能を必達
2. **配布準備の前倒し**: Phase 1で調査、Phase 6で実装（リスク軽減）
3. **自動テストの早期導入**: Phase 4でPlaywright導入（品質保証）
4. **ドキュメント化強化**: Storybook等で非エンジニア向け可視化

### 技術スタック詳細
- **状態管理**: Zustand（軽量・TypeScript親和性）
- **翻訳API**: DeepL（高品質・日本語対応、Glossary対応）
- **OCR**: Tesseract.js → 将来的にRustネイティブOCR移行
- **設定保存**: tauri-plugin-store + 暗号化
- **テスト**: Vitest（ユニット） + Playwright（E2E）
- **UI文書**: Storybook（非エンジニア向け）

---

## 成功指標詳細定義

### 性能指標
- **翻訳5秒以内**: 画像取得開始→翻訳結果表示完了まで
  - 計測地点: ドロップ開始→パネル表示
  - 対象: 2000×1200px英語UI画像
  - 環境: M1/M2 Mac, 安定ネット環境

### 品質指標
- **失敗率<5%**: 10回連続操作での成功率
  - OCR失敗: テキスト抽出0文字
  - 翻訳失敗: API呼び出し失敗・タイムアウト
  - UI失敗: アプリクラッシュ・応答なし

### 機能指標
- **設定復元100%**: アプリ再起動後の設定値維持
- **保存成功100%**: URLスキーム→フォールバック含む

### 自動計測方法
- Playwright E2Eテストで全指標を継続計測
- CI/CDパイプラインでの回帰検知
- 本番リリース前の最終検証

---

## リスク管理・対策

### 技術リスク
1. **OCR性能・精度不足**
   - 対策: Phase 2で早期検証、前処理オプション、ネイティブ移行準備

2. **Tauriプラグイン不安定**
   - 対策: Phase 1でマルチウィンドウPoC、代替手段調査

3. **翻訳API依存**
   - 対策: 抽象化レイヤー、複数プロバイダー対応設計

### プロジェクトリスク
1. **非エンジニア開発の限界**
   - 対策: 小タスク分割、Storybook活用、AI協働最適化

2. **配布・署名の複雑性**
   - 対策: Phase 1で調査、詳細手順書作成

---

## 次のアクション

1. **Phase 1 開始準備**
   - [ ] 開発環境セットアップ
   - [ ] 技術PoC計画詳細化
   - [ ] Codex MCP協働体制確立

2. **継続的改善**
   - [ ] 週次レビューでフェーズ調整
   - [ ] 成功指標の継続計測
   - [ ] ドキュメント更新

---

## 付録: Codex MCP主要指摘事項

### 重要な改善点
- OCR/翻訳の性能検証前倒し
- 配布準備の早期着手
- 成功指標の明確化・計測方法確立
- 非エンジニア向けドキュメント強化
- セキュリティ・プライバシー考慮の体系化

### 技術的考慮事項
- Tesseract.js Cold start対策
- Tauriマルチウィンドウ実装課題
- DeepL API制限・コスト最適化
- ネイティブOCR移行設計

この改良版プランは、元の要件を満たしつつ、実装上の重要なリスクと対策を体系化したものです。
